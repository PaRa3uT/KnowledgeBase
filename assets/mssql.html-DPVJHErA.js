import{_ as s,c as n,b as a,o as l}from"./app-BsHIgujo.js";const i={};function d(t,e){return l(),n("div",null,e[0]||(e[0]=[a(`<h1 id="mssql" tabindex="-1"><a class="header-anchor" href="#mssql"><span>MSSQL</span></a></h1><h2 id="модели-восстановления" tabindex="-1"><a class="header-anchor" href="#модели-восстановления"><span>Модели восстановления</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Сменить модель резервного копирования:</span>
<span class="line">ALTER DATABASE [Имя базы данных] SET RECOVERY [recovery_model]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="полная-full" tabindex="-1"><a class="header-anchor" href="#полная-full"><span>Полная (Full)</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">ALTER DATABASE db_name SET RECOVERY FULL;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><pre><code>Все изменения в базе полностью журналируются.
Журнал транзакций не будет очищаться до тех пор, как не будет сделана резервная копия журнала транзакций
Все опции восстановления доступны, когда база данных в полной модели восстановления! К примеру, мы можем «до секунды» восстановить нашу базу!
</code></pre><h3 id="с-неполным-протоколированием-bulk-logged" tabindex="-1"><a class="header-anchor" href="#с-неполным-протоколированием-bulk-logged"><span>С неполным протоколированием (Bulk-Logged)</span></a></h3><h3 id="простая-simple" tabindex="-1"><a class="header-anchor" href="#простая-simple"><span>Простая (Simple)</span></a></h3><pre><code>Изменения минимально журналируются.
Журнал транзакций (ЛОГ) автоматически очищается.
Создание резервных копий журнала транзакций невозможно, поэтому у вас остается самое ограниченное число опций по восстановлению.
</code></pre><h2 id="типы-резервного-копирования-sql-server" tabindex="-1"><a class="header-anchor" href="#типы-резервного-копирования-sql-server"><span>Типы резервного копирования SQL Server</span></a></h2><h3 id="полное-full-backup" tabindex="-1"><a class="header-anchor" href="#полное-full-backup"><span>Полное (Full Backup)</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">BACKUP DATABASE</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="дифференциальное-разностное" tabindex="-1"><a class="header-anchor" href="#дифференциальное-разностное"><span>Дифференциальное (разностное)</span></a></h3><p>Резервная копия базы данных или файлов, которые были изменены с момента создания последней полной резервной копии</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">BACKUP DATABASE ... WITH DIFFERENTIAL</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="журнал-транзакции" tabindex="-1"><a class="header-anchor" href="#журнал-транзакции"><span>Журнал транзакций</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">BACKUP LOG</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="резервное-копирование" tabindex="-1"><a class="header-anchor" href="#резервное-копирование"><span>Резервное копирование</span></a></h2><h2 id="восстановление-из-резервнои-копии" tabindex="-1"><a class="header-anchor" href="#восстановление-из-резервнои-копии"><span>Восстановление из резервной копии</span></a></h2><h2 id="перенос-tempdb" tabindex="-1"><a class="header-anchor" href="#перенос-tempdb"><span>Перенос TempDB</span></a></h2><ol><li>Создаём отдельную директорию, назовём её TempDB. На эту директорию необходимо выдать права на чтение и изменение учётной записи, от имени которой работает служба MSSQL (SQL Database Engine)</li><li>Теперь нам надо выяснить текущее расположение файлов tempdb</li></ol><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">SELECT name, physical_name AS CurrentLocation, state_desc FROM sys.master_files WHERE database_id = DB_ID(N&#39;tempdb&#39;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="3"><li>Для каждого файла нужно выполнить следующий код</li></ol><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">ALTER DATABASE database_name MODIFY FILE(NAME = logical_name, FILENAME = &#39;new_path\\file_name&#39;);</span>
<span class="line">- database_name - имя базы (в нашем случае tempdb)</span>
<span class="line">- logical_name - логическое имя файла базы</span>
<span class="line">- new_path\\file_name - новый путь и физическое имя файла</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>Рестартуем службу MSSQL (SQL Database Engine). Проверяем в настройках tempdb расположение файла</li></ol><h2 id="переименование-компьютера" tabindex="-1"><a class="header-anchor" href="#переименование-компьютера"><span>Переименование компьютера</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">SELECT @@SERVERNAME AS &#39;Server Name&#39;;  --вывод текущего имени прописанного на сервере</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">EXEC sp_dropserver &#39;WIN-P0BDIDHJ0O7&#39;;</span>
<span class="line">GO</span>
<span class="line">EXEC sp_addserver &#39;NEW-COMPUTER-NAME&#39;, local;</span>
<span class="line">GO</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="сброс-пароля" tabindex="-1"><a class="header-anchor" href="#сброс-пароля"><span>Сброс пароля</span></a></h2><ol><li>Start SQL Server in single-user mode</li></ol><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">net stop MSSQLSERVER</span>
<span class="line">net start MSSQLSERVER /m</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li></li></ol><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">ALTER LOGIN sa enable</span>
<span class="line">GO</span>
<span class="line"></span>
<span class="line">CREATE LOGIN NewSA WITH PASSWORD = &#39;Password@1234&#39;;</span>
<span class="line">ALTER SERVER ROLE sysadmin ADD MEMBER NewSA </span>
<span class="line">GO</span>
<span class="line"></span>
<span class="line">CREATE LOGIN [BUILTIN\\Administrators] FROM WINDOWS</span>
<span class="line">GO</span>
<span class="line"></span>
<span class="line">ALTER SERVER ROLE sysadmin ADD MEMBER [BUILTIN\\Administrators]</span>
<span class="line">GO</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="проверка-бд" tabindex="-1"><a class="header-anchor" href="#проверка-бд"><span>Проверка БД</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">DBCC CHECKTABLE (&lt;table_name&gt;)  проверка таблицы</span>
<span class="line">DBCC CHECKTABLE (&lt;table_name&gt;, REPAIR_REBUILD) Выполняет действия по восстановлению данных, которые можно выполнить без риска их потери</span>
<span class="line">DBCC CHECKTABLE (&lt;table_name&gt;) REPAIR_ALLOW_DATA_LOSS Пытается устранить все обнаруженные ошибки. Эти исправления могут привести к частичной потере данных</span>
<span class="line">DBCC CHECKDB (&lt;db_name&gt;) WITH NO_INFOMSGS</span>
<span class="line">DBCC CHECKDB (&lt;db_name&gt;) WITH ALL_ERRORMSGS</span>
<span class="line">DBCC CHECKDB (&lt;db_name&gt;) WITH PHYSICAL_ONLY</span>
<span class="line"></span>
<span class="line">DBCC CHECKCATALOG (TillypadSegment) WITH NO_INFOMSGS; </span>
<span class="line"></span>
<span class="line">DBCC CHECKDB (&#39;MyBase&#39;, REPAIR_ALLOW_DATA_LOSS)</span>
<span class="line">----------------------------------------</span>
<span class="line">ALTER DATABASE [MyBase] SET SINGLE_USER</span>
<span class="line">GO</span>
<span class="line">DBCC CHECKTABLE (&lt;table_name&gt;, REPAIR_REBUILD)</span>
<span class="line">GO</span>
<span class="line">ALTER DATABASE [MyBase] SET MULTI_USER</span>
<span class="line">GO</span>
<span class="line">---------------------------------------</span>
<span class="line">ALTER DATABASE [MyBase] SET EMERGENCY</span>
<span class="line">GO</span>
<span class="line">ALTER DATABASE [MyBase] SET SINGLE_USER WITH ROLLBACK IMMEDIATE</span>
<span class="line">GO</span>
<span class="line">DBCC CHECKDB (&#39;MyBase&#39;, REPAIR_ALLOW_DATA_LOSS)</span>
<span class="line">GO</span>
<span class="line">ALTER DATABASE [MyBase] SET MULTI_USER</span>
<span class="line">GO</span>
<span class="line">----------------------------------------</span>
<span class="line">Необходимо перевести базу данных в режим EMERGENCY:</span>
<span class="line">    EXEC sp_resetstatus &#39;yourDBname&#39;;</span>
<span class="line">    ALTER DATABASE yourDBname SET EMERGENCY</span>
<span class="line"></span>
<span class="line">Выполнять тестирование базы:</span>
<span class="line">    DBCC checkdb(&#39;yourDBname&#39;)</span>
<span class="line">    --переводим базу в однопользовательский режим</span>
<span class="line">    ALTER DATABASE yourDBname SET SINGLE_USER (ALTER DATABASE yourDBname SET SINGLE_USER WITH ROLLBACK IMMEDIATE)</span>
<span class="line">    -- пытаемся сначала rebuild сделать</span>
<span class="line">    DBCC CHECKDB(&#39;MyDataBase&#39;, REPAIR_REBUILD)</span>
<span class="line">    --восстанавливаем с потерей данных, или пытаемся сначала rebuild сделать</span>
<span class="line">    DBCC CheckDB (&#39;yourDBname&#39;, REPAIR_ALLOW_DATA_LOSS)</span>
<span class="line">    --возвращаем доступ к базе</span>
<span class="line">    ALTER DATABASE yourDBname SET MULTI_USER</span>
<span class="line">------------------------------------------</span>
<span class="line"></span>
<span class="line">ALTER DATABASE myDB</span>
<span class="line">SET SINGLE_USER</span>
<span class="line">WITH ROLLBACK IMMEDIATE;</span>
<span class="line">GO</span>
<span class="line">DBCC CHECKDB (&#39;myDB&#39;, REPAIR_REBUILD);</span>
<span class="line">DBCC CHECKDB (&#39;myDB&#39;, repair_allow_data_loss); -- параметры чека подбирались в зависимости от выполнения DBCC CHECKDB с REPAIR_REBUILD;</span>
<span class="line">GO</span>
<span class="line">ALTER DATABASE myDB</span>
<span class="line">SET MULTI_USER;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="планы-обслуживания" tabindex="-1"><a class="header-anchor" href="#планы-обслуживания"><span>Планы обслуживания</span></a></h2><p>Еженедельный (Раз в неделю в вс. в 02:00): Проверка целостности базы данных (Базы данных: &lt;db_name&gt;; Включить индексы; Только физическое) Резервное копирование базы данных ( Тип резервной копии: Полное; Базы данных: &lt;db_name&gt;; Создать резервную копию на: Диск; Создать файл резервной копии для каждой базы данных; Папка: F:\\Backup\\MSSQL; Расширение файла резервной копии: bak; Проверять целостность резервной копии )</p><p>Ежедневный (Раз в день в 00:00): Ежечасный (Каждый день, каждый час) (только при полной модели восстановления) Резервное копирование журнала транзакций (trn)</p><p>X дефрагментацию индексов обновлять статистику</p><h2 id="запросы" tabindex="-1"><a class="header-anchor" href="#запросы"><span>Запросы</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Версия сервера</span>
<span class="line">Select @@version</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="параметры-влияющие-на-производительность" tabindex="-1"><a class="header-anchor" href="#параметры-влияющие-на-производительность"><span>Параметры влияющие на производительность</span></a></h2><h2 id="разросшиися-журнал-транзакции" tabindex="-1"><a class="header-anchor" href="#разросшиися-журнал-транзакции"><span>Разросшийся журнал транзакций</span></a></h2><p>Самое простое средство для однократного (но не для регулярного) уменьшения &quot;нечаянно&quot; выросшего лога транзакций: прочтитать документацию, сделать резервную копию базы, перевести в SIMPLE, шринкнуть файл лога в 0, увеличить файл лога до 0,25-0,5 размера базы, включить FULL, следать резервную копию, настроить резервное копирование регулярное для данных и для журнала транзакций, забыть об этой проблеме</p>`,44)]))}const c=s(i,[["render",d],["__file","mssql.html.vue"]]),p=JSON.parse('{"path":"/unsorted/mssql.html","title":"MSSQL","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Модели восстановления","slug":"модели-восстановления","link":"#модели-восстановления","children":[{"level":3,"title":"Полная (Full)","slug":"полная-full","link":"#полная-full","children":[]},{"level":3,"title":"С неполным протоколированием (Bulk-Logged)","slug":"с-неполным-протоколированием-bulk-logged","link":"#с-неполным-протоколированием-bulk-logged","children":[]},{"level":3,"title":"Простая (Simple)","slug":"простая-simple","link":"#простая-simple","children":[]}]},{"level":2,"title":"Типы резервного копирования SQL Server","slug":"типы-резервного-копирования-sql-server","link":"#типы-резервного-копирования-sql-server","children":[{"level":3,"title":"Полное (Full Backup)","slug":"полное-full-backup","link":"#полное-full-backup","children":[]},{"level":3,"title":"Дифференциальное (разностное)","slug":"дифференциальное-разностное","link":"#дифференциальное-разностное","children":[]},{"level":3,"title":"Журнал транзакций","slug":"журнал-транзакции","link":"#журнал-транзакции","children":[]}]},{"level":2,"title":"Резервное копирование","slug":"резервное-копирование","link":"#резервное-копирование","children":[]},{"level":2,"title":"Восстановление из резервной копии","slug":"восстановление-из-резервнои-копии","link":"#восстановление-из-резервнои-копии","children":[]},{"level":2,"title":"Перенос TempDB","slug":"перенос-tempdb","link":"#перенос-tempdb","children":[]},{"level":2,"title":"Переименование компьютера","slug":"переименование-компьютера","link":"#переименование-компьютера","children":[]},{"level":2,"title":"Сброс пароля","slug":"сброс-пароля","link":"#сброс-пароля","children":[]},{"level":2,"title":"Проверка БД","slug":"проверка-бд","link":"#проверка-бд","children":[]},{"level":2,"title":"Планы обслуживания","slug":"планы-обслуживания","link":"#планы-обслуживания","children":[]},{"level":2,"title":"Запросы","slug":"запросы","link":"#запросы","children":[]},{"level":2,"title":"Параметры влияющие на производительность","slug":"параметры-влияющие-на-производительность","link":"#параметры-влияющие-на-производительность","children":[]},{"level":2,"title":"Разросшийся журнал транзакций","slug":"разросшиися-журнал-транзакции","link":"#разросшиися-журнал-транзакции","children":[]}],"git":{"updatedTime":1712295845000,"contributors":[{"name":"PaRa3uT","username":"PaRa3uT","email":"PaRa3uT.74@gmail.com","commits":2,"url":"https://github.com/PaRa3uT"}]},"filePathRelative":"unsorted/mssql.md"}');export{c as comp,p as data};
